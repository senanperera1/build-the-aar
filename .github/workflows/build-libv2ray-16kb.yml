name: Patch AAR to 16KB (No Rebuild)

on:
  workflow_dispatch:

jobs:
  patch:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout to get AAR
      uses: actions/checkout@v4
      
    - name: Install tools
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq binutils patchelf
        
    - name: Extract AAR
      run: |
        mkdir -p aar_extracted
        unzip -q libv2ray.aar -d aar_extracted
        ls -la aar_extracted/
        
    - name: Check original library
      run: |
        echo "Original native library:"
        ls -lh aar_extracted/jni/arm64-v8a/libgojni.so
        echo ""
        echo "Current page alignment (0x1000 = 4KB):"
        readelf -l aar_extracted/jni/arm64-v8a/libgojni.so | grep LOAD
        
    - name: Setup NDK 27
      run: |
        wget -q https://dl.google.com/android/repository/android-ndk-r27-linux.zip
        unzip -q android-ndk-r27-linux.zip
        export NDK_ROOT=$PWD/android-ndk-r27
        echo "NDK_ROOT=$PWD/android-ndk-r27" >> $GITHUB_ENV
        
    - name: Relink native library with 16KB alignment
      run: |
        cd aar_extracted/jni/arm64-v8a
        
        # Backup original
        cp libgojni.so libgojni.so.backup
        
        # Use NDK linker to relink with 16KB page size
        $NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang \
          -shared \
          -Wl,-soname,libgojni.so \
          -Wl,-z,max-page-size=0x4000 \
          -Wl,--whole-archive libgojni.so.backup -Wl,--no-whole-archive \
          -o libgojni.so
          
    - name: Verify new alignment
      run: |
        echo "New page alignment (should be 0x4000 = 16KB):"
        readelf -l aar_extracted/jni/arm64-v8a/libgojni.so | grep LOAD
        
    - name: Repack AAR
      run: |
        cd aar_extracted
        zip -r ../libv2ray-16kb.aar *
        cd ..
        ls -lh libv2ray-16kb.aar
        
    - name: Upload patched AAR
      uses: actions/upload-artifact@v4
      with:
        name: libv2ray-16kb-PATCHED
        path: libv2ray-16kb.aar
