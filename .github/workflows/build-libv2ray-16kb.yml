name: Build libv2ray 16KB

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Setup JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Install NDK 27
      run: |
        echo "y" | sdkmanager --install "ndk;27.0.12077973"
        echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/27.0.12077973" >> $GITHUB_ENV
        
    - name: Install gomobile
      run: |
        go install golang.org/x/mobile/cmd/gomobile@latest
        go install golang.org/x/mobile/cmd/gobind@latest
        gomobile init
        
    - name: Clone v2ray-core
      run: git clone --depth 1 -b v5.16.1 https://github.com/v2fly/v2ray-core.git
        
    - name: Create wrapper
      run: |
        mkdir -p libv2ray
        cat > libv2ray/libv2ray.go << 'EOF'
        package libv2ray

        import (
            "context"
            "errors"
            "fmt"
            "strings"
            "sync"

            v2core "github.com/v2fly/v2ray-core/v5"
            v2stats "github.com/v2fly/v2ray-core/v5/app/stats"
            v2serial "github.com/v2fly/v2ray-core/v5/infra/conf/serial"
            _ "github.com/v2fly/v2ray-core/v5/main/distro/all"
        )

        type V2RayPoint struct {
            instance   *v2core.Instance
            statsMan   v2stats.Manager
            isRunning  bool
            cancelFunc context.CancelFunc
            mu         sync.Mutex
        }

        func NewV2RayPoint() *V2RayPoint {
            return &V2RayPoint{isRunning: false}
        }

        func (v *V2RayPoint) IsRunning() bool {
            v.mu.Lock()
            defer v.mu.Unlock()
            return v.isRunning
        }

        func (v *V2RayPoint) RunLoop(configContent string) error {
            v.mu.Lock()
            if v.isRunning {
                v.mu.Unlock()
                return errors.New("already running")
            }
            v.mu.Unlock()

            config, err := v2serial.LoadJSONConfig(strings.NewReader(configContent))
            if err != nil {
                return fmt.Errorf("config error: %v", err)
            }

            ctx, cancel := context.WithCancel(context.Background())
            instance, err := v2core.New(config)
            if err != nil {
                cancel()
                return fmt.Errorf("instance error: %v", err)
            }

            if err := instance.Start(); err != nil {
                cancel()
                return fmt.Errorf("start error: %v", err)
            }

            v.mu.Lock()
            v.instance = instance
            v.cancelFunc = cancel
            v.isRunning = true
            v.mu.Unlock()

            go func() { <-ctx.Done() }()
            return nil
        }

        func (v *V2RayPoint) StopLoop() error {
            v.mu.Lock()
            defer v.mu.Unlock()

            if !v.isRunning {
                return errors.New("not running")
            }

            if v.instance != nil {
                v.instance.Close()
                v.instance = nil
            }

            if v.cancelFunc != nil {
                v.cancelFunc()
                v.cancelFunc = nil
            }

            v.isRunning = false
            return nil
        }
        EOF

    - name: Setup go.mod
      run: |
        cd libv2ray
        go mod init libv2ray
        go mod edit -require=github.com/v2fly/v2ray-core/v5@v5.16.1
        go mod tidy
        
    - name: Build AAR
      run: |
        export PATH=$PATH:$HOME/go/bin
        gomobile bind -v -target=android -androidapi=21 -ldflags="-s -w" -o libv2ray.aar ./libv2ray
          
    - name: Upload AAR
      uses: actions/upload-artifact@v4
      with:
        name: libv2ray-16kb-aar
        path: libv2ray.aar
