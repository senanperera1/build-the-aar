name: Build libv2ray 16KB NUCLEAR

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Go 1.22
      uses: actions/setup-go@v5
      with:
        go-version: '1.22.10'

    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Install NDK 27
      run: |
        echo "y" | sdkmanager --install "ndk;27.0.12077973"
        echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/27.0.12077973" >> $GITHUB_ENV
        echo "NDK installed at: $ANDROID_SDK_ROOT/ndk/27.0.12077973"
        
    - name: Setup Go environment variables
      run: |
        echo "GOPATH=$HOME/go" >> $GITHUB_ENV
        echo "PATH=$HOME/go/bin:$PATH" >> $GITHUB_ENV
        echo "GO111MODULE=on" >> $GITHUB_ENV
        mkdir -p $HOME/go/bin
        mkdir -p $HOME/go/pkg
        mkdir -p $HOME/go/src
        
    - name: Clean Go cache
      run: |
        go clean -modcache || true
        rm -rf $HOME/go/pkg/mod || true
        
    - name: Install gomobile and gobind
      run: |
        go install -v golang.org/x/mobile/cmd/gomobile@latest
        go install -v golang.org/x/mobile/cmd/gobind@latest
        ls -la $HOME/go/bin/
        
    - name: Initialize gomobile properly
      run: |
        export PATH=$HOME/go/bin:$PATH
        export ANDROID_HOME=$ANDROID_SDK_ROOT
        export ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/27.0.12077973
        gomobile init -v -ndk $ANDROID_SDK_ROOT/ndk/27.0.12077973
        echo "Gomobile initialized successfully"
        
    - name: Verify gomobile installation
      run: |
        export PATH=$HOME/go/bin:$PATH
        which gomobile
        which gobind
        gomobile version || true
        ls -la $HOME/go/pkg/gomobile || true
        
    - name: Clone v2ray-core
      run: |
        cd $GITHUB_WORKSPACE
        git clone --depth 1 -b v5.16.1 https://github.com/v2fly/v2ray-core.git
        echo "V2Ray core cloned"
        
    - name: Create libv2ray wrapper
      run: |
        cd $GITHUB_WORKSPACE
        mkdir -p libv2ray
        cat > libv2ray/libv2ray.go << 'EOFMARKER'
        package libv2ray

        import (
            "context"
            "errors"
            "fmt"
            "strings"
            "sync"

            v2core "github.com/v2fly/v2ray-core/v5"
            v2stats "github.com/v2fly/v2ray-core/v5/app/stats"
            v2serial "github.com/v2fly/v2ray-core/v5/infra/conf/serial"
            _ "github.com/v2fly/v2ray-core/v5/main/distro/all"
        )

        type V2RayPoint struct {
            instance   *v2core.Instance
            statsMan   v2stats.Manager
            isRunning  bool
            cancelFunc context.CancelFunc
            mu         sync.Mutex
        }

        func NewV2RayPoint() *V2RayPoint {
            return &V2RayPoint{isRunning: false}
        }

        func (v *V2RayPoint) IsRunning() bool {
            v.mu.Lock()
            defer v.mu.Unlock()
            return v.isRunning
        }

        func (v *V2RayPoint) RunLoop(configContent string) error {
            v.mu.Lock()
            if v.isRunning {
                v.mu.Unlock()
                return errors.New("already running")
            }
            v.mu.Unlock()

            config, err := v2serial.LoadJSONConfig(strings.NewReader(configContent))
            if err != nil {
                return fmt.Errorf("config error: %v", err)
            }

            ctx, cancel := context.WithCancel(context.Background())
            instance, err := v2core.New(config)
            if err != nil {
                cancel()
                return fmt.Errorf("instance error: %v", err)
            }

            if err := instance.Start(); err != nil {
                cancel()
                return fmt.Errorf("start error: %v", err)
            }

            v.mu.Lock()
            v.instance = instance
            v.cancelFunc = cancel
            v.isRunning = true
            v.mu.Unlock()

            go func() { <-ctx.Done() }()
            return nil
        }

        func (v *V2RayPoint) StopLoop() error {
            v.mu.Lock()
            defer v.mu.Unlock()

            if !v.isRunning {
                return errors.New("not running")
            }

            if v.instance != nil {
                v.instance.Close()
                v.instance = nil
            }

            if v.cancelFunc != nil {
                v.cancelFunc()
                v.cancelFunc = nil
            }

            v.isRunning = false
            return nil
        }
        EOFMARKER
        echo "Wrapper created"
        cat libv2ray/libv2ray.go

    - name: Initialize go module with dependencies
      run: |
        cd $GITHUB_WORKSPACE/libv2ray
        go mod init libv2ray
        echo "Go module initialized"
        
    - name: Add v2ray-core dependency
      run: |
        cd $GITHUB_WORKSPACE/libv2ray
        go mod edit -require=github.com/v2fly/v2ray-core/v5@v5.16.1
        echo "Dependency added"
        cat go.mod
        
    - name: Download all dependencies
      run: |
        cd $GITHUB_WORKSPACE/libv2ray
        go mod download
        go mod tidy
        echo "Dependencies downloaded"
        
    - name: Verify module is ready
      run: |
        cd $GITHUB_WORKSPACE/libv2ray
        go list -m all
        go build -v .
        echo "Module verified and builds successfully"
        
    - name: Build AAR with gomobile
      run: |
        export PATH=$HOME/go/bin:$PATH
        export ANDROID_HOME=$ANDROID_SDK_ROOT
        export ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/27.0.12077973
        export CGO_ENABLED=1
        cd $GITHUB_WORKSPACE
        echo "Current directory: $(pwd)"
        echo "Contents:"
        ls -la
        echo "Building AAR..."
        gomobile bind -v \
          -target=android \
          -androidapi=21 \
          -ldflags="-s -w" \
          -o libv2ray.aar \
          ./libv2ray
        echo "Build complete!"
        
    - name: Verify AAR was created
      run: |
        cd $GITHUB_WORKSPACE
        if [ -f libv2ray.aar ]; then
          echo "✓ AAR file created successfully!"
          ls -lh libv2ray.aar
          file libv2ray.aar
          unzip -l libv2ray.aar | head -20
        else
          echo "✗ AAR file NOT found!"
          ls -la
          exit 1
        fi
        
    - name: Extract and verify native library
      run: |
        cd $GITHUB_WORKSPACE
        unzip -q libv2ray.aar -d aar_contents
        echo "AAR contents:"
        find aar_contents -type f
        if [ -f aar_contents/jni/arm64-v8a/libgojni.so ]; then
          echo "✓ Native library found!"
          ls -lh aar_contents/jni/arm64-v8a/libgojni.so
          readelf -h aar_contents/jni/arm64-v8a/libgojni.so | grep Machine || true
        else
          echo "✗ Native library NOT found!"
        fi
          
    - name: Upload AAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: libv2ray-16kb-aar
        path: ${{ github.workspace }}/libv2ray.aar
        if-no-files-found: error
        
    - name: Create release info
      run: |
        cd $GITHUB_WORKSPACE
        cat > BUILD_INFO.txt << 'INFOEOF'
        Build Information
        =================
        Date: $(date)
        NDK Version: 27.0.12077973
        Go Version: 1.22.10
        V2Ray Core: v5.16.1
        Target API: 21+
        Architecture: arm64-v8a
        Page Size: 16KB compatible
        
        File Details:
        $(ls -lh libv2ray.aar)
        
        Usage:
        1. Download libv2ray.aar
        2. Replace old AAR in your Android project libs folder
        3. Clean and rebuild your project
        4. No code changes needed!
        INFOEOF
        cat BUILD_INFO.txt
        
    - name: Upload build info
      uses: actions/upload-artifact@v4
      with:
        name: build-info
        path: ${{ github.workspace }}/BUILD_INFO.txt
