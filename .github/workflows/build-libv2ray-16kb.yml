name: Build libv2ray 16KB

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout dummy repo
      run: |
        mkdir -p $GITHUB_WORKSPACE
        cd $GITHUB_WORKSPACE
        git init
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Setup JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Install NDK 27
      run: |
        echo "y" | sdkmanager --install "ndk;27.0.12077973"
        echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/27.0.12077973" >> $GITHUB_ENV
        
    - name: Install gomobile
      run: |
        go install golang.org/x/mobile/cmd/gomobile@latest
        go install golang.org/x/mobile/cmd/gobind@latest
        $HOME/go/bin/gomobile init
        
    - name: Create GOPATH structure
      run: |
        mkdir -p $HOME/gopath/src
        echo "GOPATH=$HOME/gopath" >> $GITHUB_ENV
        
    - name: Clone v2ray-core to GOPATH
      run: |
        mkdir -p $HOME/gopath/src/github.com/v2fly
        cd $HOME/gopath/src/github.com/v2fly
        git clone --depth 1 -b v5.16.1 https://github.com/v2fly/v2ray-core.git
        
    - name: Create libv2ray in GOPATH
      run: |
        mkdir -p $HOME/gopath/src/libv2ray
        cd $HOME/gopath/src/libv2ray
        cat > libv2ray.go << 'EOF'
        package libv2ray

        import (
            "context"
            "errors"
            "fmt"
            "strings"
            "sync"

            v2core "github.com/v2fly/v2ray-core/v5"
            v2stats "github.com/v2fly/v2ray-core/v5/app/stats"
            v2serial "github.com/v2fly/v2ray-core/v5/infra/conf/serial"
            _ "github.com/v2fly/v2ray-core/v5/main/distro/all"
        )

        type V2RayPoint struct {
            instance   *v2core.Instance
            statsMan   v2stats.Manager
            isRunning  bool
            cancelFunc context.CancelFunc
            mu         sync.Mutex
        }

        func NewV2RayPoint() *V2RayPoint {
            return &V2RayPoint{isRunning: false}
        }

        func (v *V2RayPoint) IsRunning() bool {
            v.mu.Lock()
            defer v.mu.Unlock()
            return v.isRunning
        }

        func (v *V2RayPoint) RunLoop(configContent string) error {
            v.mu.Lock()
            if v.isRunning {
                v.mu.Unlock()
                return errors.New("already running")
            }
            v.mu.Unlock()

            config, err := v2serial.LoadJSONConfig(strings.NewReader(configContent))
            if err != nil {
                return fmt.Errorf("config error: %v", err)
            }

            ctx, cancel := context.WithCancel(context.Background())
            instance, err := v2core.New(config)
            if err != nil {
                cancel()
                return fmt.Errorf("instance error: %v", err)
            }

            if err := instance.Start(); err != nil {
                cancel()
                return fmt.Errorf("start error: %v", err)
            }

            v.mu.Lock()
            v.instance = instance
            v.cancelFunc = cancel
            v.isRunning = true
            v.mu.Unlock()

            go func() { <-ctx.Done() }()
            return nil
        }

        func (v *V2RayPoint) StopLoop() error {
            v.mu.Lock()
            defer v.mu.Unlock()

            if !v.isRunning {
                return errors.New("not running")
            }

            if v.instance != nil {
                v.instance.Close()
                v.instance = nil
            }

            if v.cancelFunc != nil {
                v.cancelFunc()
                v.cancelFunc = nil
            }

            v.isRunning = false
            return nil
        }
        EOF

    - name: Initialize go module
      run: |
        cd $HOME/gopath/src/libv2ray
        go mod init libv2ray || true
        go mod edit -require=github.com/v2fly/v2ray-core/v5@v5.16.1 || true
        go mod tidy || true
        
    - name: Download dependencies
      run: |
        cd $HOME/gopath/src/libv2ray
        go get github.com/v2fly/v2ray-core/v5@v5.16.1 || true
        go mod download || true
        
    - name: Build AAR with all fixes
      run: |
        export PATH=$PATH:$HOME/go/bin
        export GOPATH=$HOME/gopath
        export GO111MODULE=auto
        export CGO_ENABLED=1
        cd $HOME/gopath/src
        echo "Building from: $(pwd)"
        ls -la
        $HOME/go/bin/gomobile bind -v -target=android -androidapi=21 -ldflags="-s -w" -o $GITHUB_WORKSPACE/libv2ray.aar libv2ray
      env:
        ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
        
    - name: Verify AAR exists
      run: |
        ls -lh $GITHUB_WORKSPACE/libv2ray.aar || echo "AAR NOT FOUND!"
        file $GITHUB_WORKSPACE/libv2ray.aar || echo "Cannot check file type"
          
    - name: Upload AAR
      uses: actions/upload-artifact@v4
      with:
        name: libv2ray-16kb-aar
        path: ${{ github.workspace }}/libv2ray.aar
